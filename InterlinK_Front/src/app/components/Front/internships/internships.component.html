<app-navbar></app-navbar>
<div class="internships-container">
  <h1 class="title">Find Your Ideal Internship</h1>
  <div class="internships-layout">
    <!-- Filters on the right -->
    <div class="filters-section">
      <h3>Filters</h3>
      <div class="filter-group">
        <label for="location">üìç Location</label>
        <input
          type="text"
          id="location"
          [(ngModel)]="locationFilter"
          (ngModelChange)="applyFilters()"s
          placeholder="Enter a city"
        />
      </div>
      <div class="filter-group">
        <label for="duration">‚è≥ Duration</label>
        <select
          id="duration"
          [(ngModel)]="durationFilter"
          (ngModelChange)="applyFilters()"
        >
          <option value="">All durations</option>
          <option value="FOUR_WEEKS">4 weeks</option>
          <option value="SIX_WEEKS">6 weeks</option>
          <option value="EIGHT_WEEKS">8 weeks</option>
          <option value="SIX_MONTHS">6 months</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="type">üìå Type</label>
        <select
          id="type"
          [(ngModel)]="typeFilter"
          (ngModelChange)="applyFilters()"
        >
          <option value="">All types</option>
          <option value="FULL_TIME">Full-time</option>
          <option value="PART_TIME">Part-time</option>
          <option value="REMOTE">Remote</option>
          <option value="HYBRID">Hybrid</option>
        </select>
      </div>
      <!-- Bouton pour ouvrir le formulaire de CV -->
    <button class="generate-cv-btn" (click)="showCVForm = true">Generate My Automatic CV</button>
    <button class="recommend-btn" (click)="showRecommendations()">üéØ Recommended for Me</button>
    </div>
<!-- CV Modal -->
<div *ngIf="showCVForm" class="modal-overlay">
  <div class="cv-modal">
    <button class="close-btn" (click)="showCVForm = false">&times;</button>
    
    <h2 class="modal-title">CV Creation</h2>
    
    <form [formGroup]="cvForm" class="cv-form">
      <!-- Personal Information -->
      <div class="form-section">
        <h3 class="section-title">Personal Information</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" formControlName="fullName" placeholder="Your full name">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" formControlName="email" placeholder="example@email.com">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Phone</label>
            <input type="text" formControlName="phone" placeholder="Phone number">
          </div>
          <div class="form-group">
            <label>Address</label>
            <input type="text" formControlName="address" placeholder="Your address">
          </div>
        </div>
        <div class="form-group">
          <label>Professional Profile</label>
          <textarea formControlName="profile" placeholder="Professional summary (50-100 words)"></textarea>
        </div>
      </div>

      <!-- Education -->
      <div formArrayName="education">
        <div class="section-header">
          <h3 class="section-title">Education</h3>
          <button type="button" class="add-btn" (click)="addEducation()">+ Add</button>
        </div>
        
        <div *ngFor="let edu of getEducationControls(); let i=index" [formGroupName]="i" class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label>Degree</label>
              <input formControlName="degree" placeholder="Ex: Bachelor's in Computer Science">
            </div>
            <div class="form-group">
              <label>Institution</label>
              <input formControlName="institution" placeholder="Ex: ESPRIT University">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Year</label>
              <input formControlName="year" placeholder="Ex: 2020-2023">
            </div>
            <button type="button" class="remove-btn" (click)="removeEducation(i)">Remove</button>
          </div>
        </div>
      </div>

      <!-- Professional Experience -->
      <div formArrayName="experiences">
        <div class="section-header">
          <h3 class="section-title">Professional Experience</h3>
          <button type="button" class="add-btn" (click)="addExperience()">+ Add</button>
        </div>
        
        <div *ngFor="let exp of getExperienceControls(); let i=index" [formGroupName]="i" class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label>Position</label>
              <input formControlName="title" placeholder="Ex: Full Stack Developer">
            </div>
            <div class="form-group">
              <label>Company</label>
              <input formControlName="company" placeholder="Ex: XYZ Company">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Period</label>
              <input formControlName="period" placeholder="Ex: June 2022 - August 2022">
            </div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea formControlName="description" placeholder="Your responsibilities and achievements"></textarea>
          </div>
          <button type="button" class="remove-btn" (click)="removeExperience(i)">Remove</button>
        </div>
      </div>

      <!-- Skills -->
      <div class="form-section">
        <h3 class="section-title">Skills</h3>
        <div class="skills-container">
          <div class="skill-tags">
            <span *ngFor="let tag of availableSkills" 
                  class="skill-tag"
                  [class.selected]="isSkillSelected(tag)"
                  (click)="toggleSkill(tag)">
              {{tag}}
            </span>
          </div>
          <div class="skill-input-container">
            <input type="text" class="skill-input" placeholder="Add a skill" 
                   (keyup.enter)="addCustomSkill($event)">
            <button type="button" class="add-skill-btn" (click)="addCustomSkillFromInput()">+</button>
          </div>
        </div>
      </div>

      <!-- Languages -->
      <div formArrayName="languages">
        <div class="section-header">
          <h3 class="section-title">Languages</h3>
          <button type="button" class="add-btn" (click)="addLanguage()">+ Add</button>
        </div>
        
        <div *ngFor="let lang of getLanguageControls(); let i=index" [formGroupName]="i" class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label>Language</label>
              <input formControlName="name" placeholder="Ex: French">
            </div>
            <div class="form-group">
              <label>Level</label>
              <select formControlName="level">
                <option value="Beginner">Beginner</option>
                <option value="Intermediate">Intermediate</option>
                <option value="Advanced">Advanced</option>
                <option value="Fluent">Fluent</option>
              </select>
            </div>
          </div>
          <button type="button" class="remove-btn" (click)="removeLanguage(i)">Remove</button>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="form-actions">
        <button type="button" class="btn btn-preview" (click)="previewCV()">Preview</button>
        <button type="button" class="btn btn-download" (click)="generatePDF()">Generate PDF</button>
        <button type="button" class="btn btn-save" (click)="saveDraft()">Save draft</button>
        <button type="button" class="btn btn-cancel" (click)="showCVForm = false">Cancel</button>
      </div>
    </form>
  </div>
    <!-- CV Preview -->
    <div *ngIf="previewMode" class="cv-preview-container">
      <div id="cv-preview" class="cv-preview">
        <!-- CV content will be generated here -->
      </div>
      <div class="preview-actions">
        <button (click)="previewMode = false">Back to editing</button>
        <button (click)="generatePDF()">Download PDF</button>
      </div>
    </div>
</div>
    <!-- Internship list -->
    <div class="internships-list">
      <div *ngFor="let internship of filteredInternships" class="internship-card">
        <h3 class="internship-title">{{ internship.title }}</h3>
        <p class="company-name">{{ internship.companyName }}</p>
        <p class="location">üìç {{ internship.localisation }}</p>
        <p class="duration">‚è≥ {{ internship.duration }}</p>
        <p class="type">üìå {{ internship.type }}</p>
        <p class="start-date">üìÖ Start date: {{ internship.startDate | date:'dd/MM/yyyy' }}</p>
        <p class="available-spots">üë• Available spots: {{ internship.availableSpots }}</p>
        <!-- Rating display -->
        <div class="rating" *ngIf="getRating(internship.internshipId) > 0">
          ‚òÖ {{ getRating(internship.internshipId) | number:'1.1-1' }}
          ({{ getRatingCount(internship.internshipId) }} avis)
        </div>

        <!-- Rate button -->
        <button 
          *ngIf="!hasRated(internship.internshipId)"
          (click)="openRatingModal(internship)"
          class="rate-btn"
        >
        Rate this internship
        </button>

        <button (click)="applyForInternship(internship)" class="apply-btn">Apply</button>
      </div>
    </div>
  </div>

  <!-- Application form modal -->
  <div *ngIf="selectedInternship" class="modal-overlay">
    <!-- Your existing application form -->
  </div>

  <!-- Rating modal -->
  <div *ngIf="selectedInternshipForRating" class="modal-overlay">
    <div class="rating-modal">
      <h3>Noter {{ selectedInternshipForRating.title }}</h3>
      <button (click)="selectedInternshipForRating = null" class="close-btn">&times;</button>
      <div class="stars">
        <span 
          *ngFor="let star of [1,2,3,4,5]" 
          (click)="selectedRating = star"
          [class.active]="star <= selectedRating">‚òÖ</span>
      </div>
      <textarea [(ngModel)]="ratingComment" placeholder="Votre avis..."></textarea>
      <button (click)="submitRating()">Envoyer</button>
    </div>
  </div>
  <!-- Application form overlay (modal) -->
  <div *ngIf="selectedInternship" class="modal-overlay">
    <div class="application-form">
      <h3 class="form-title">Apply for: {{ selectedInternship.title }}</h3>
      <button (click)="cancelApplication()" class="close-btn">&times;</button>
      <form (ngSubmit)="onSubmitAddApplication()">
       
        <div class="mb-3">
          <label for="firstName" class="form-label">First Name</label>
          <input type="text" id="firstName" class="form-control" formControlName="firstName">
        </div>
        <div class="mb-3">
          <label for="lastName" class="form-label">Last Name</label>
          <input type="text" id="lastName" class="form-control" formControlName="lastName">
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" id="email" class="form-control" formControlName="email">
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">Phone</label>
          <input type="tel" id="phone" class="form-control" formControlName="phone">
        </div>
       
        <div class="form-group">
          <label for="cv">CV</label>
          <input
          type="file"
          id="cv"
          class="form-control"
          (change)="onFileSelected($event)"
          accept=".pdf,.doc,.docx,.txt"
          required
        />        </div>
      
        <div class="mb-3">
          <label for="status" class="form-label">Status</label>
          <select id="status" class="form-control" formControlName="status">
            <option *ngFor="let status of getEnumValues(ApplicationStatus)" [value]="status">
              {{ formatEnumValue(status) }}
            </option>
          </select>
        </div>
  
        <div class="btn-group">
          <button type="submit" class="submit-btn">Submit</button>
          <button type="button" (click)="cancelApplication()" class="cancel-btn">Cancel</button>
        </div>
      </form>
    </div>
  </div>
 <!-- Chatbot int√©gr√© -->
<!-- Chatbot int√©gr√© -->
<div class="chatbot-container" [class.open]="chatbot.isOpen">
  <div class="chatbot-header" (click)="toggleChatbot()">
    <div class="chatbot-title">
      <i class="fas fa-robot"></i>
      <h3>Assistant Stages</h3>
    </div>
    <span class="toggle-icon">{{ chatbot.isOpen ? '‚àí' : '+' }}</span>
  </div>

  <div class="chatbot-body" *ngIf="chatbot.isOpen">
    <div class="messages-container">
      <div class="messages">
        <div *ngFor="let msg of chatbot.messages" 
             [class.user-message]="msg.sender === 'user'" 
             [class.bot-message]="msg.sender === 'bot'">
          <div class="message-content">
            <span *ngIf="msg.sender === 'bot'" class="bot-avatar">
              <i class="fas fa-robot"></i>
            </span>
            {{ msg.text }}
          </div>
        </div>
        
        <div *ngIf="chatbot.isLoading" class="typing-indicator">
          <span>‚óè</span><span>‚óè</span><span>‚óè</span>
        </div>
      </div>
    </div>

    <div class="suggestions" *ngIf="chatbot.messages.length <= 1">
      <p>Essayez de demander :</p>
      <div class="suggestion-buttons">
        <button *ngFor="let suggestion of chatbot.suggestions" 
                (click)="selectSuggestion(suggestion)">
          {{ suggestion }}
        </button>
      </div>
    </div>

    <div class="input-area">
      <input [(ngModel)]="chatbot.userMessage" 
             placeholder="Posez votre question..." 
             (keyup.enter)="sendChatbotMessage()"
             [disabled]="chatbot.isLoading">
      <button (click)="sendChatbotMessage()" [disabled]="!chatbot.userMessage.trim() || chatbot.isLoading">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>
</div>
<!-- Add this new modal for recommendations -->
<div *ngIf="showRecommendationsModal" class="modal-overlay">
  <div class="recommendations-modal">
    <div class="modal-header">
      <h2>Recommended Internships</h2>
      <button class="close-btn" (click)="closeRecommendations()">&times;</button>
    </div>
    
    <div class="skills-selection">
      <h3>Select Your Skills</h3>
      <div class="skill-tags">
        <span *ngFor="let skill of availableSkills" 
              class="skill-tag"
              [class.selected]="isSkillSelected(skill)"
              (click)="toggleSkill(skill)">
          {{skill}}
        </span>
      </div>
      <div class="skill-input-wrapper">
        <input type="text" 
               class="skill-input" 
               placeholder="Add a custom skill"
               [(ngModel)]="newSkill"
               (keyup.enter)="addCustomSkillFromInput()">
        <button (click)="addCustomSkillFromInput()" class="add-skill-btn">+</button>
      </div>
      <button class="find-matches-btn" (click)="findRecommendedInternships()">Find Matches</button>
    </div>

    <!-- Only show this section when there are recommendations -->
    <div class="recommendations-list" *ngIf="recommendedInternships && recommendedInternships.length > 0">
      <!-- Only show internships with a score greater than 0 -->
      <div *ngFor="let rec of recommendedInternships" class="recommendation-card" [style.display]="rec.score > 0 ? 'block' : 'none'">
        <div class="match-score" [ngClass]="{
          'high-match': rec.score >= 0.7,
          'medium-match': rec.score >= 0.4 && rec.score < 0.7,
          'low-match': rec.score < 0.4
        }">
          {{ (rec.score * 100).toFixed(0) }}% Match
        </div>
        <h3>{{rec.internship.title}}</h3>
        <p class="company">{{rec.internship.companyName}}</p>
        <p class="location">üìç {{rec.internship.location}}</p>
        <p class="duration">‚è≥ {{rec.internship.duration}}</p>
        <p class="type">üìå {{rec.internship.type}}</p>
        <p class="start-date">üìÖ Start: {{rec.internship.startDate | date}}</p>
        <p class="spots">üë• Available spots: {{rec.internship.availableSpots}}</p>
        <button class="apply-btn" (click)="applyForInternship(rec.internship)">Apply Now</button>
      </div>
    </div>

    <!-- Show this when no matches are found -->
    <div class="no-matches" *ngIf="recommendedInternships && recommendedInternships.length === 0">
      <p>No matching internships found. Try selecting different skills.</p>
    </div>
  </div>
</div>